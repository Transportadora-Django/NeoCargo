{% extends "base.html" %}
{% load static %}

{% block title %}{{ titulo }} - NeoCargo{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/pedidos-listar.css' %}">
{% endblock %}

{% block content %}
<div class="pedidos-header">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <h1 class="pedidos-title">
                    <i class="fas fa-crown me-2"></i>{{ titulo }}
                </h1>
                <p class="pedidos-subtitle mb-0">
                    Visão geral e gestão completa do sistema NeoCargo
                </p>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'gestao:listar_usuarios' %}" class="btn btn-new-pedido">
                    <i class="fas fa-users me-2"></i>Usuários
                </a>
                <a href="{% url 'gestao:listar_solicitacoes' %}" class="btn btn-new-pedido">
                    <i class="fas fa-tasks me-2"></i>Solicitações
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container pb-5">
    {% if total_solicitacoes_pendentes > 0 %}
    <div class="alert alert-warning d-flex align-items-center justify-content-between mb-4" role="alert">
        <div>
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Atenção!</strong> Você tem {{ total_solicitacoes_pendentes }} solicitação{% if total_solicitacoes_pendentes > 1 %}ões{% endif %} pendente{% if total_solicitacoes_pendentes > 1 %}s{% endif %}.
        </div>
        <a href="{% url 'gestao:listar_solicitacoes' %}" class="btn btn-sm btn-warning">
            <i class="fas fa-eye me-1"></i>Ver Solicitações
        </a>
    </div>
    {% endif %}
    
    {% if pedidos_pendentes > 0 %}
    <div class="pedido-card mb-4" style="background: linear-gradient(135deg, #fff5e6 0%, #ffe8cc 100%); border: 2px solid #f59e0b; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.15);">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
            <div class="d-flex align-items-center gap-3">
                <div style="background: #f59e0b; color: #fff; width: 60px; height: 60px; border-radius: 15px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <i class="fas fa-clipboard-check" style="font-size: 1.75rem;"></i>
                </div>
                <div>
                    <h5 class="pedido-id mb-1" style="color: #d97706;">
                        <i class="fas fa-hourglass-half me-2"></i>{{ pedidos_pendentes }} Pedido{% if pedidos_pendentes > 1 %}s{% endif %} Aguardando Aprovação
                    </h5>
                    <p class="pedido-info-label mb-0" style="color: #92400e;">
                        {% if pedidos_pendentes == 1 %}
                            Há um pedido aguardando sua análise e atribuição de motorista e veículo.
                        {% else %}
                            Há {{ pedidos_pendentes }} pedidos aguardando sua análise e atribuição de motorista e veículo.
                        {% endif %}
                    </p>
                </div>
            </div>
            <a href="{% url 'gestao:pedidos_para_aprovacao' %}" class="btn btn-new-pedido" style="background: #f59e0b; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);">
                <i class="fas fa-clipboard-check me-2"></i>
                Analisar Pedidos
            </a>
        </div>
    </div>
    {% endif %}

    {% if total_problemas_pendentes > 0 or total_problemas_em_analise > 0 %}
    <div class="pedido-card mb-4" style="background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); border: 2px solid #ef4444; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.15);">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
            <div class="d-flex align-items-center gap-3">
                <div style="background: #ef4444; color: #fff; width: 60px; height: 60px; border-radius: 15px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 1.75rem;"></i>
                </div>
                <div>
                    <h5 class="pedido-id mb-1" style="color: #dc2626;">
                        <i class="fas fa-tools me-2"></i>Problemas Reportados
                    </h5>
                    <p class="pedido-info-label mb-0" style="color: #991b1b;">
                        {{ total_problemas_pendentes }} pendente{% if total_problemas_pendentes != 1 %}s{% endif %} e 
                        {{ total_problemas_em_analise }} em análise
                    </p>
                </div>
            </div>
            <a href="{% url 'gestao:listar_problemas' %}" class="btn btn-new-pedido" style="background: #ef4444; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);">
                <i class="fas fa-search me-2"></i>
                Ver Problemas
            </a>
        </div>
    </div>
    {% endif %}

    <h2 class="pedidos-title mb-4" style="color: var(--neocargo-navy);">
        <i class="fas fa-chart-line me-2"></i>Visão Geral
    </h2>
    <div class="row g-4 mb-5">
        <div class="col-lg-3 col-md-6">
            <div class="pedido-card">
                <div class="d-flex align-items-center gap-3">
                    <div class="pedido-icon" style="background: rgb(59 130 246 / 10%); color: #3b82f6; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fas fa-users" style="font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <div class="pedido-info-label">Total de Usuários</div>
                        <div class="pedido-id">{{ total_usuarios }}</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="pedido-card">
                <div class="d-flex align-items-center gap-3">
                    <div class="pedido-icon" style="background: rgb(34 197 94 / 10%); color: #22c55e; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fas fa-user" style="font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <div class="pedido-info-label">Clientes</div>
                        <div class="pedido-id">{{ total_clientes }}</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="pedido-card">
                <div class="d-flex align-items-center gap-3">
                    <div class="pedido-icon" style="background: rgb(6 182 212 / 10%); color: #06b6d4; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fas fa-id-card" style="font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <div class="pedido-info-label">Motoristas</div>
                        <div class="pedido-id">{{ total_motoristas }}</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="pedido-card">
                <div class="d-flex align-items-start gap-3">
                    <div class="pedido-icon" style="background: rgb(251 146 60 / 10%); color: #fb923c; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 4px;">
                        <i class="fas fa-clock" style="font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <div class="pedido-info-label">Solicitações Pendentes</div>
                        <div class="pedido-id">{{ total_solicitacoes_pendentes }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h2 class="pedidos-title mb-4 mt-5" style="color: var(--neocargo-navy);">
        <i class="fas fa-box me-2"></i>Estatísticas de Pedidos
    </h2>
    <div class="row g-4 mb-5">
        <div class="col-lg-3 col-md-6">
            <div class="pedido-card">
                <div class="d-flex align-items-center gap-3">
                    <div class="pedido-icon" style="background: rgb(59 130 246 / 10%); color: #3b82f6; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fas fa-shopping-cart" style="font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <div class="pedido-info-label">Total de Pedidos</div>
                        <div class="pedido-id">{{ total_pedidos }}</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="pedido-card">
                <div class="d-flex align-items-center gap-3">
                    <div class="pedido-icon" style="background: rgb(6 182 212 / 10%); color: #06b6d4; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fas fa-hourglass-half" style="font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <div class="pedido-info-label">Aguardando Escolha</div>
                        <div class="pedido-id">{{ pedidos_cotacao }}</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="pedido-card">
                <div class="d-flex align-items-center gap-3">
                    <div class="pedido-icon" style="background: rgb(251 146 60 / 10%); color: #fb923c; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fas fa-clipboard-list" style="font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <div class="pedido-info-label">Pendentes</div>
                        <div class="pedido-id">{{ pedidos_pendentes }}</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="pedido-card">
                <div class="d-flex align-items-center gap-3">
                    <div class="pedido-icon" style="background: rgb(168 85 247 / 10%); color: #a855f7; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fas fa-truck" style="font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <div class="pedido-info-label">Em Transporte</div>
                        <div class="pedido-id">{{ pedidos_em_transporte }}</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="pedido-card">
                <div class="d-flex align-items-center gap-3">
                    <div class="pedido-icon" style="background: rgb(34 197 94 / 10%); color: #22c55e; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fas fa-check-circle" style="font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <div class="pedido-info-label">Concluídos</div>
                        <div class="pedido-id">{{ pedidos_concluidos }}</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="pedido-card">
                <div class="d-flex align-items-center gap-3">
                    <div class="pedido-icon" style="background: rgb(239 68 68 / 10%); color: #ef4444; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fas fa-times-circle" style="font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <div class="pedido-info-label">Cancelados</div>
                        <div class="pedido-id">{{ pedidos_cancelados }}</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="pedido-card">
                <div class="d-flex align-items-center gap-3">
                    <div class="pedido-icon" style="background: rgb(59 130 246 / 10%); color: #3b82f6; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fas fa-truck-moving" style="font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <div class="pedido-info-label">Tipos de Veículos</div>
                        <div class="pedido-id">{{ total_veiculos }}</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="pedido-card">
                <div class="d-flex align-items-center gap-3">
                    <div class="pedido-icon" style="background: rgb(6 182 212 / 10%); color: #06b6d4; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fas fa-city" style="font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <div class="pedido-info-label">Cidades Ativas</div>
                        <div class="pedido-id">{{ total_cidades }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h2 class="pedidos-title mb-4 mt-5" style="color: var(--neocargo-navy);">
        <i class="fas fa-cog me-2"></i>Controle do Sistema
    </h2>
    <div class="row g-4 mb-5">
        <div class="col-12">
            <div class="pedido-card">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <div>
                        <h5 class="pedido-id mb-2">
                            <i class="fas fa-toggle-on me-2"></i>Solicitações de Mudança de Perfil
                        </h5>
                        <p class="pedido-info-label mb-0">
                            {% if config.solicitacoes_abertas %}
                                <i class="fas fa-check-circle text-success me-1"></i>Sistema aceitando novas solicitações
                            {% else %}
                                <i class="fas fa-pause-circle text-danger me-1"></i>Solicitações pausadas
                            {% endif %}
                        </p>
                    </div>
                    <form method="post" action="{% url 'gestao:toggle_solicitacoes' %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-new-pedido {% if config.solicitacoes_abertas %}text-white{% endif %}" style="{% if config.solicitacoes_abertas %}background: #ef4444;{% else %}background: #22c55e;{% endif %}">
                            {% if config.solicitacoes_abertas %}
                                <i class="fas fa-pause me-2"></i>Pausar
                            {% else %}
                                <i class="fas fa-play me-2"></i>Abrir
                            {% endif %}
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <h2 class="pedidos-title mb-4 mt-5" style="color: var(--neocargo-navy);">
        <i class="fas fa-history me-2"></i>Atividade Recente
    </h2>
    <div class="row g-4 mb-5">
        <div class="col-lg-6">
            <div class="pedido-card" style="height: 100%;">
                <div class="pedido-header">
                    <h5 class="pedido-id mb-0">
                        <i class="fas fa-box me-2"></i>Pedidos Recentes
                    </h5>
                    <a href="{% url 'pedidos:listar' %}" class="btn btn-sm" style="background: var(--neocargo-cyan); color: #fff; padding: 0.375rem 0.75rem; border-radius: 8px; text-decoration: none;">
                        <i class="fas fa-eye me-1"></i>Ver Todos
                    </a>
                </div>
                <div class="pedido-body" style="display: block; max-height: 400px; overflow-y: auto;">
                    {% for pedido in pedidos_recentes|slice:":5" %}
                    <div class="d-flex justify-content-between align-items-center py-3 {% if not forloop.last %}border-bottom{% endif %}" style="border-color: #f1f5f9 !important;">
                        <div style="flex: 1; min-width: 0;">
                            <div class="pedido-id" style="font-size: 0.95rem;">#{{ pedido.numero_pedido_cliente }}</div>
                            <small class="pedido-info-label" style="display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ pedido.cliente.get_full_name|default:pedido.cliente.username }}</small>
                            {% if pedido.atribuicao %}
                                <small class="pedido-info-label text-muted" style="display:block;">Motorista: {{ pedido.atribuicao.motorista.profile.user.get_full_name|default:pedido.atribuicao.motorista.profile.user.username }} - Veículo: {{ pedido.atribuicao.veiculo.placa }}</small>
                            {% elif pedido.veiculo_final %}
                                <small class="pedido-info-label text-muted" style="display:block;">Veículo sugerido: {{ pedido.veiculo_final }}</small>
                            {% endif %}
                        </div>
                        <div class="text-end" style="flex-shrink: 0; margin-left: 1rem;">
                            {% if pedido.status == 'cotacao' %}
                                <span class="status-badge status-cotacao">Cotação</span>
                            {% elif pedido.status == 'pendente' %}
                                <span class="status-badge status-pendente">Pendente</span>
                            {% elif pedido.status == 'em_transporte' %}
                                <span class="status-badge status-em-transporte">Em Transporte</span>
                            {% elif pedido.status == 'concluido' %}
                                <span class="status-badge status-concluido">Concluído</span>
                            {% elif pedido.status == 'cancelado' %}
                                <span class="status-badge status-cancelado">Cancelado</span>
                            {% endif %}<br>
                            <small class="pedido-date" style="white-space: nowrap;">{{ pedido.created_at|date:"d/m/Y H:i" }}</small>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-center py-5 mb-0" style="color: #94a3b8;">Nenhum pedido encontrado.</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="pedido-card" style="height: 100%;">
                <div class="pedido-header">
                    <h5 class="pedido-id mb-0">
                        <i class="fas fa-user-plus me-2"></i>Novos Usuários
                    </h5>
                    <a href="{% url 'gestao:listar_usuarios' %}" class="btn btn-sm" style="background: var(--neocargo-cyan); color: #fff; padding: 0.375rem 0.75rem; border-radius: 8px; text-decoration: none;">
                        <i class="fas fa-eye me-1"></i>Ver Todos
                    </a>
                </div>
                <div class="pedido-body" style="display: block; max-height: 400px; overflow-y: auto;">
                    {% for usuario in usuarios_recentes|slice:":5" %}
                    <div class="d-flex justify-content-between align-items-center py-3 {% if not forloop.last %}border-bottom{% endif %}" style="border-color: #f1f5f9 !important;">
                        <div style="flex: 1; min-width: 0;">
                            <div class="pedido-id" style="font-size: 0.95rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ usuario.get_full_name|default:usuario.username }}</div>
                            <small class="pedido-info-label" style="display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ usuario.email }}</small>
                        </div>
                        <div class="text-end" style="flex-shrink: 0; margin-left: 1rem;">
                            {% if usuario.profile %}
                                {% if usuario.profile.role == 'cliente' %}
                                    <span class="status-badge status-aprovado">Cliente</span>
                                {% elif usuario.profile.role == 'motorista' %}
                                    <span class="status-badge status-em-transporte">Motorista</span>
                                {% elif usuario.profile.role == 'owner' %}
                                    <span class="status-badge" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: #fff; border: none;">Owner</span>
                                {% endif %}
                            {% else %}
                                <span class="status-badge status-cancelado">Sem Perfil</span>
                            {% endif %}<br>
                            <small class="pedido-date" style="white-space: nowrap;">{{ usuario.date_joined|date:"d/m/Y" }}</small>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-center py-5 mb-0" style="color: #94a3b8;">Nenhum usuário encontrado.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <h2 class="pedidos-title mb-4 mt-5" style="color: var(--neocargo-navy);">
        <i class="fas fa-bolt me-2"></i>Ações Rápidas
    </h2>
    <div class="row g-4 mb-5">
        <div class="col-lg-3 col-md-6">
            <a href="{% url 'gestao:listar_usuarios' %}" class="text-decoration-none">
                <div class="pedido-card" style="transition: all 0.3s ease; cursor: pointer; height: 100%;">
                    <div class="text-center">
                        <div class="pedido-icon mx-auto mb-3" style="background: rgb(59 130 246 / 10%); color: #3b82f6; width: 60px; height: 60px; border-radius: 15px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-users" style="font-size: 1.75rem;"></i>
                        </div>
                        <h5 class="pedido-id mb-2">Gerenciar Usuários</h5>
                        <p class="pedido-info-label mb-0" style="min-height: 40px;">Visualize e gerencie todos os usuários do sistema</p>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-lg-3 col-md-6">
            <a href="{% url 'gestao:listar_solicitacoes' %}" class="text-decoration-none">
                <div class="pedido-card" style="transition: all 0.3s ease; cursor: pointer; height: 100%;">
                    <div class="text-center">
                        <div class="pedido-icon mx-auto mb-3" style="background: rgb(251 146 60 / 10%); color: #fb923c; width: 60px; height: 60px; border-radius: 15px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-tasks" style="font-size: 1.75rem;"></i>
                        </div>
                        <h5 class="pedido-id mb-2">Solicitações</h5>
                        <p class="pedido-info-label mb-0" style="min-height: 40px;">Aprove ou rejeite solicitações de mudança de perfil</p>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-lg-3 col-md-6">
            <a href="{% url 'rotas:configurar_precos' %}" class="text-decoration-none">
                <div class="pedido-card" style="transition: all 0.3s ease; cursor: pointer; height: 100%;">
                    <div class="text-center">
                        <div class="pedido-icon mx-auto mb-3" style="background: rgb(6 182 212 / 10%); color: #06b6d4; width: 60px; height: 60px; border-radius: 15px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-route" style="font-size: 1.75rem;"></i>
                        </div>
                        <h5 class="pedido-id mb-2">Configurar Preços</h5>
                        <p class="pedido-info-label mb-0" style="min-height: 40px;">Atualize preços de combustível e margem de lucro</p>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-lg-3 col-md-6">
            <a href="{% url 'admin:index' %}" class="text-decoration-none">
                <div class="pedido-card" style="transition: all 0.3s ease; cursor: pointer; height: 100%;">
                    <div class="text-center">
                        <div class="pedido-icon mx-auto mb-3" style="background: rgb(239 68 68 / 10%); color: #ef4444; width: 60px; height: 60px; border-radius: 15px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-tools" style="font-size: 1.75rem;"></i>
                        </div>
                        <h5 class="pedido-id mb-2">Admin Django</h5>
                        <p class="pedido-info-label mb-0" style="min-height: 40px;">Acesse o painel administrativo completo</p>
                    </div>
                </div>
            </a>
        </div>
    </div>
</div>
{% endblock %}
